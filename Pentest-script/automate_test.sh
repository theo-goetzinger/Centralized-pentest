#!/bin/bash

if [ -z "$IP" ]
then
        echo "Put an IP to run the script: ./automate_v1.sh <IP>"
        exit 1
fi

printf "\n----- NMAP -----\n\n" > results                       # Mise en page du Nmap dans results


PS3='Choose Nmap scan to run: '
options=("Default Scan" "CVE Finder" "Option 3" "Quit")
select opt in "${options[@]}"
do
    case $opt in
        "Default Scan")
            echo "Running default Nmap scan..."
            nmap $IP -sC -sV -Pn -oN ./results                              # Lancement de la commande nmap : -sC = default nmap script ; -sV = version detection ; -Pn = Treat all hosts, skip host detection
            while read line                                                 
            do
                    if [[ $line == *open* ]] && [[ $line == *http* ]]       # Si nmap trouve ouvert le port 80, alors il lance un dirb + whatweb
                    then
                            echo "Running Dirb..."
                            dirb http://$IP /usr/share/wordlists/dirb/common.txt -o temp1

                    echo "Running WhatWeb..."
                    whatweb $IP -v > temp2
                    fi
            done < results
            if [ -e temp1 ]                                                 # Ecrire le résultat du dirb dans results
            then
                    printf "\n----- DIRS -----\n\n" >> results
                    cat temp1 >> results
                    rm temp1
            fi

            if [ -e temp2 ]                                                 # Ecrire le résultat du Whatweb dans results
            then
                    printf "\n----- WEB -----\n\n" >> results
                    cat temp2 >> results
                    rm temp2
            fi
            ;;
        "CVE Finder")
            echo "Running Nmap CVE scripts"
            nmap -sV --script nmap-vulners/vulners.nse,vulscan/vulscan.nse --script-args vulscandb=scipvuldb.csv $IP
            while read line                                                 
            do
                    if [[ $line == *open* ]] && [[ $line == *http* ]]       # Si nmap trouve ouvert le port 80, alors il lance un dirb + whatweb
                    then
                            echo "Running Dirb..."
                            dirb http://$IP /usr/share/wordlists/dirb/common.txt -o temp1

                            echo "Running WhatWeb..."
                            whatweb $IP -v > temp2
                    fi
            done < results
            if [ -e temp1 ]                                                 # Ecrire le résultat du dirb dans results
            then
                    printf "\n----- DIRS -----\n\n" >> results
                    cat temp1 >> results
                    rm temp1
            fi

            if [ -e temp2 ]                                                 # Ecrire le résultat du Whatweb dans results
            then
                    printf "\n----- WEB -----\n\n" >> results
                    cat temp2 >> results
                    rm temp2
            fi
            ;;
        "Option 3")
            echo "you chose choice $REPLY which is $opt"
            ;;
        "Quit")
            break
            ;;
        *) echo "invalid option $REPLY";;
    esac
done




if [ -e temp1 ]                                                 # Ecrire le résultat du dirb dans results
then
        printf "\n----- DIRS -----\n\n" >> results
        cat temp1 >> results
        rm temp1
fi

if [ -e temp2 ]                                                 # Ecrire le résultat du Whatweb dans results
then
    printf "\n----- WEB -----\n\n" >> results
        cat temp2 >> results
        rm temp2
fi

#cat results                                                    # Afficher l'ensemble des résultats